<script type="text/discourse-plugin" version="0.8">
    const { h } = require('virtual-dom');
    const { iconNode } = require('discourse-common/lib/icon-library');

    const disraptorMenuItems = [
        {
            text: 'Home',
            href: '/'
        },
        {
            text: 'Tasks',
            href: '/tira9-client-web/tasks'
        }
    ];

    // This renames the reference to the “bars” icon to “disraptor-bars”.
    // This way, we can reference the “bars” icon with a different name (i.e. “disraptor-bars”).
    api.replaceIcon('disraptor-bars', 'bars')

    // This renames the reference to the “fab-discourse” to “bars”.
    // Since the “fab-discourse” is originally used for Discourse’s main navigation, it will now use the “bars” icon.
    api.replaceIcon('bars', 'fab-discourse');

    // header-contents:after inserts after div.contents.clearfix
    api.decorateWidget('header-icons:after', function () {
        return getDisraptorMenuWrapper();
    });

    // Closes the Disraptor menu when clicking outside.
    document.addEventListener('mousedown', function (event) {
        if (event.buttons !== 1) {
            return;
        }

        const clickedOnToggle = event.target.closest('.disraptor-menu-toggle') !== null;
        if (clickedOnToggle) {
            return;
        }

        const clickedOnNav = event.target.closest('.disraptor-panel') !== null;
        if (!clickedOnNav) {
            const disraptorMenuToggle = document.querySelector('.disraptor-menu-toggle');
            disraptorMenuToggle.setAttribute('aria-expanded', 'false');
        }
    });

    function getDisraptorMenuWrapper() {
        return h(
            'li.header-dropdown-toggle',
            [
                getDisraptorMenuToggle(),
                getDisraptorMenu()
            ]
        );
    }

    function getDisraptorMenuToggle() {
        return h(
            'button.disraptor-menu-toggle.icon.btn-flat',
            {
                type: 'button',
                onclick: toggleDisraptorMenu,
                attributes: {
                    'aria-label': 'Disraptor Nav',
                    'aria-expanded': 'false'
                }
            },
            iconNode('disraptor-bars')
        );
    }

    function getDisraptorMenu() {
        return h(
            'div.disraptor-panel',
            h(
                'div.menu-panel',
                {
                    attributes: {
                        'data-max-width': '320'
                    }
                },
                h(
                    'div.panel-body',
                    h(
                        'div.panel-body-contents.clearfix',
                        h(
                            'ul.disraptor-menu',
                            disraptorMenuItems.map(item => h('li', h('a', { href: item.href }, item.text)))
                        )
                    )
                )
            )
        );
    }

    function toggleDisraptorMenu(event) {
        const isExpanded = event.currentTarget.getAttribute('aria-expanded') === 'true';
        event.currentTarget.setAttribute('aria-expanded', !isExpanded);
    }
</script>
