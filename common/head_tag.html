<script type="text/discourse-plugin" version="0.8">
    const { h } = require('virtual-dom');
    const { iconNode } = require('discourse-common/lib/icon-library');

    const disraptorMenuItems = [
        {
            text: 'Home',
            href: '/'
        },
        {
            text: 'Tasks',
            href: '/tira9-client-web/tasks'
        }
    ];

    // This renames the reference to the “bars” icon to “disraptor-bars”.
    // This way, we can reference the “bars” icon with a different name (i.e. “disraptor-bars”).
    api.replaceIcon('disraptor-bars', 'bars')

    // This renames the reference to the “fab-discourse” to “bars”.
    // Since the “fab-discourse” is originally used for Discourse’s main navigation, it will now use the “bars” icon.
    api.replaceIcon('bars', 'fab-discourse');

    api.createWidget('disraptor-menu', {
        tagName: 'div.disraptor-panel',

        panelContents() {
            return h(
                'ul.disraptor-menu',
                disraptorMenuItems.map(item => h('li', h('a', { href: item.href }, item.text)))
            );
        },

        html() {
            return this.attach('menu-panel', {
                contents: () => this.panelContents()
            });
        },

        clickOutside(e) {
            if (this.site.mobileView) {
                this.clickOutsideMobile(e);
            } else {
                this.sendWidgetAction('toggleDisraptorMenu');
            }
        },

        clickOutsideMobile(e) {
            const $centeredElement = $(document.elementFromPoint(e.clientX, e.clientY));
            if (
                $centeredElement.parents(".panel").length &&
                !$centeredElement.hasClass("header-cloak")
            ) {
                this.sendWidgetAction("toggleDisraptorMenu");
            } else {
                const $window = $(window);
                const windowWidth = parseInt($window.width(), 10);
                const $panel = $(".menu-panel");
                $panel.addClass("animate");
                const panelOffsetDirection = this.site.mobileView ? "left" : "right";
                $panel.css(panelOffsetDirection, -windowWidth);
                const $headerCloak = $(".header-cloak");
                $headerCloak.addClass("animate");
                $headerCloak.css("opacity", 0);
                Ember.run.later(() => this.sendWidgetAction("toggleDisraptorMenu"), 200);
            }
        }
    });

    api.decorateWidget('header-icons:after', function(helper) {
        const headerState = helper.widget.parentWidget.state;

        let contents = [];
        contents.push(helper.attach('header-dropdown', {
          title: 'disraptor-menu',
          icon: 'disraptor-bars',
          active: headerState.disraptorMenuVisible,
          iconId: 'toggle-disraptor-menu',
          action: 'toggleDisraptorMenu',
        }));

        if (headerState.disraptorMenuVisible) {
            contents.push(helper.attach('disraptor-menu'));
        }

        return contents;
    });

    api.attachWidgetAction('header', 'toggleDisraptorMenu', function() {
        this.state.disraptorMenuVisible = !this.state.disraptorMenuVisible;
    });
</script>
